<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>XIGO - Encuesta Oficial</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKs (Versiones estables para m√°xima compatibilidad) -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <style>
        :root { --xigo: #2D5A27; }
        .text-xigo { color: var(--xigo); }
        .bg-xigo { background-color: var(--xigo); }
        .border-xigo { border-color: var(--xigo); }
        .option-selected { border-color: var(--xigo); background-color: #f0fdf4; color: var(--xigo); transform: scale(1.02); }
        
        body { 
            background-color: #f1f5f9; 
            -webkit-font-smoothing: antialiased; 
            margin: 0;
            padding: 0;
        }

        .app-container { 
            max-width: 450px; 
            margin: 0 auto; 
            min-height: 100vh; 
            background: white; 
            display: flex; 
            flex-direction: column; 
        }
        
        .brand-header {
            background-color: #000000;
            padding: 0;
            border-bottom: 4px solid var(--xigo);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            overflow: hidden;
            height: 120px;
        }

        .brand-logo-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
    </style>
</head>
<body>

<div class="app-container shadow-2xl relative">
    <!-- Header -->
    <header class="brand-header cursor-pointer" id="admin-trigger">
        <img src="https://lh3.googleusercontent.com/u/0/d/1WmKpnJPnBgB3OyYqe-a-OgRODLuuPjTq=w1000" alt="XIGO Logo" class="brand-logo-img" onerror="this.src='https://via.placeholder.com/450x120?text=XIGO+PREMIUM'">
    </header>

    <!-- Indicador de Preguntas Restantes -->
    <div class="px-8 pt-6">
        <div class="w-full bg-gray-100 h-1.5 rounded-full overflow-hidden">
            <div id="prog-bar" class="bg-xigo h-full w-0 transition-all duration-700"></div>
        </div>
        <div class="flex justify-between mt-2">
            <span id="section-name" class="text-[9px] font-black text-xigo uppercase tracking-widest italic">Cargando...</span>
            <span id="questions-left" class="text-[9px] font-bold text-gray-400 uppercase tracking-tighter">Calculando...</span>
        </div>
    </div>

    <!-- Contenedor de Preguntas -->
    <main id="survey-ui" class="flex-1 px-8 py-8 overflow-y-auto custom-scrollbar">
        <!-- Renderizado din√°mico -->
    </main>

    <!-- Footer Fijo para Multiopci√≥n -->
    <footer id="footer-ui" class="px-8 pb-8 hidden">
        <button id="next-btn" onclick="next()" class="w-full bg-xigo text-white py-5 rounded-2xl font-black uppercase tracking-widest shadow-xl active:scale-95 transition-all">
            Continuar
        </button>
    </footer>
</div>

<script>
    // --- L√ìGICA DE ALMACENAMIENTO (FIREBASE) ---
    let db = null;
    let auth = null;
    const appId = typeof __app_id !== 'undefined' ? __app_id : "xigo-final-survey-2026";
    const ADMIN_PASS = "XIGO2026";

    // Inicializaci√≥n con re-intento y manejo de errores
    const initStorage = async () => {
        try {
            if (typeof __firebase_config !== 'undefined') {
                const config = JSON.parse(__firebase_config);
                firebase.initializeApp(config);
                db = firebase.firestore();
                auth = firebase.auth();
                
                // Autenticaci√≥n para asegurar que los datos se guarden en el servidor
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await auth.signInWithCustomToken(__initial_auth_token);
                } else {
                    await auth.signInAnonymously();
                }
                console.log("Conectado a la base de datos de XIGO");
            }
        } catch (e) {
            console.error("Error conectando a la base de datos:", e);
        }
    };

    initStorage();

    // --- CONTENIDO DE LA ENCUESTA (23 PREGUNTAS) ---
    const questions = [
        { s: 'Filtro', id: 'F1', q: '¬øEn los √∫ltimos 30 d√≠as, has comprado comida preparada o empacada para consumir fuera de casa o en tu trabajo/universidad?', opt: ['S√≠, lo he comprado', 'No, pero lo considerar√≠a si fuera conveniente', 'No, no me interesa'], type: 'single', exit: 'No, no me interesa' },
        { s: 'Filtro', id: 'F2', q: '¬øCu√°l describe mejor tu situaci√≥n actual?', opt: ['Trabajo fuera de casa', 'Trabajo desde casa/online', 'Trabajo mixto [Oficina + casa]', 'Estudiante/ No trabajo'], type: 'single' },
        { s: 'Filtro', id: 'F3', q: '¬øCon qu√© frecuencia almuerzas fuera de casa en una semana?', opt: ['0 veces', '1-2 veces', '3-4 veces', '5+ veces'], type: 'single' },
        { s: 'Comida', id: 'C1', q: '¬øHas comprado alguna vez comida preparada para consumir despu√©s (Refrigerada o en tarrinas empacadas)?', opt: ['S√≠, regularmente', 'S√≠, algunas veces', 'No, pero me llama la atenci√≥n', 'No, no me interesa'], type: 'single' },
        { s: 'Comida', id: 'C2', q: '¬øEn qu√© situaciones considerar√≠as consumir comida lista durante un d√≠a laboral?', opt: ['Con poco tiempo para salir almorzar', 'Reuniones o trabajo continuo', 'No alcance a cocinarme', 'Para comer en la oficina', 'Entre reuniones o traslados', 'Para llevar a casa'], type: 'multi', max: 6 },
        { s: 'Comida', id: 'C3', q: '¬øQu√© tipo de comida te genera m√°s apetito y confianza si viene lista y empacada?', opt: ['Comida tradicional ecuatoriana', 'Comida casera ligera (arroz, carne, pollo)', 'Bowls balanceados (sushi, prote√≠na, pasta)', 'Ensaladas completas', 'Sopas/cremas', 'Snacks salados'], type: 'multi', max: 3 },
        { s: 'Comida', id: 'C4', q: 'Para tu almuerzo/cena, ¬øqu√© tama√±o de porci√≥n prefieres normalmente?', opt: ['Ligero (para no sentirse pesado)', 'Normal (me deja satisfecho)', 'Grande (me gusta quedar lleno)', 'Depende del d√≠a'], type: 'single' },
        { s: 'Comida', id: 'C5', q: '¬øQu√© esperas de un almuerzo para sentir que "vali√≥ la pena"?', opt: ['Que me llene (porci√≥n)', 'Que sea saludable', 'Que tenga buena cantidad de prote√≠na', 'Que sea r√°pido y pr√°ctico', 'Que tenga muy buen sabor'], type: 'multi', max: 3 },
        { s: 'Comida', id: 'C6', q: '¬øQu√© factor te har√≠a dudar al comprar comida empacada?', opt: ['Frescura', 'Higiene', 'Sabor', 'Precio', 'Tama√±o de la porci√≥n', 'Uso de conservantes', 'Empaque sostenible'], type: 'multi', max: 3 },
        { s: 'Comida', id: 'C7', q: 'Si tuvieras acceso a comida lista, fresca y de buena calidad, ¬øcon qu√© frecuencia la consumir√≠as?', opt: ['Nunca', '1 vez por semana', '2-3 veces por semana', 'Casi todos los d√≠as'], type: 'single' },
        { s: 'Delivery', id: 'D1', q: '¬øConsiderar√≠as pedir comida lista por delivery si fuera confiable, fresca y de buena calidad?', opt: ['S√≠, con frecuencia', 'S√≠, ocasionalmente', 'Tal vez', 'No'], type: 'single' },
        { s: 'Delivery', id: 'D2', q: 'Cuando piensas en pedir por delivery, ¬øqu√© formato te resulta m√°s atractivo?', opt: ['Pedir una comida puntual', 'Pedir comida para 2-3 d√≠as', 'Pedir para toda la semana laboral', 'Depende del momento'], type: 'single' },
        { s: 'Delivery', id: 'D3', q: 'Si este tipo de comida estuviera disponible por delivery, ¬øcon qu√© frecuencia la pedir√≠as?', opt: ['Nunca', '1 vez por semana', '2-3 veces por semana', 'M√°s de 3 veces por semana'], type: 'single' },
        { s: 'Precio', id: 'P1', q: '¬øEn promedio, cu√°nto sueles pagar hoy por tu almuerzo entre semana?', opt: ['Menos de $4.99', '$5.99-$7.99', '$7.99-$9.99', '$9.99-$11.99', '$11.99 o m√°s', 'No pago almuerzo'], type: 'single' },
        { s: 'Precio', id: 'P2', q: '¬øQu√© precio te parece razonable para un almuerzo listo, fresco y de excelente calidad?', opt: ['Menos de $4.99', '$5.99-$7.99', '$7.99-$9.99', '$9.99-$11.99', '$11.99 o m√°s'], type: 'single' },
        { s: 'Precio', id: 'P3', q: '¬øA partir de qu√© precio considerar√≠as que este tipo de almuerzo ya es CARO?', opt: ['Menos de $4.99', '$5.99-$7.99', '$7.99-$9.99', '$9.99-$11.99', '$11.99 o m√°s'], type: 'single' },
        { s: 'Precio', id: 'P4', q: 'Si un almuerzo que hoy compras a $5.99 pasara a costar $7.99 por mejores ingredientes, ¬øqu√© har√≠as?', opt: ['Lo seguir√≠a comprando igual', 'Lo comprar√≠a con menos frecuencia', 'Buscar√≠a otra opci√≥n', 'Dejar√≠a de comprarlo'], type: 'single' },
        { s: 'Bebidas', id: 'R1', q: 'Durante tu jornada laboral, ¬øcompras bebidas listas para tomar?', opt: ['S√≠, casi todos los d√≠as', 'Varias veces por semana', 'Ocasionalmente', 'Rara vez', 'Nunca'], type: 'single' },
        { s: 'Bebidas', id: 'R2', q: '¬øCu√°l de estas opciones te resultar√≠a m√°s atractiva en tu d√≠a a d√≠a?', opt: ['Agua natural o saborizada', 'Jugo natural prensado', 'T√© fr√≠o o infusi√≥n natural', 'Caf√© latte y Matcha', 'Bebida funcional (energ√≠a/prote√≠na)', 'Refresco para el calor'], type: 'multi', max: 2 },
        { s: 'Bebidas', id: 'R3', q: '¬øQu√© tipo de leche prefieres normalmente en tus bebidas?', opt: ['Leche regular', 'Leche deslactosada', 'Leche de almendra', 'Leche de avena', 'Leche de soya', 'No consumo leche'], type: 'multi', max: 2 },
        { s: 'Bebidas', id: 'R4', q: '¬øQu√© precio te parece razonable para una bebida lista para tomar (RTD) de buena calidad?', opt: ['Hasta $1.99', '$2.49-$2.99', '$3.49-$3.99', '$4.49-$4.99', 'M√°s de $5.00'], type: 'single' },
        { s: 'Perfil', id: 'D1_Edad', q: '¬øCu√°l es tu rango de edad?', opt: ['18-24', '25-34', '35-44', '45-54', '55+'], type: 'single' },
        { s: 'Perfil', id: 'D2_Zona', q: '¬øEn qu√© zona de Guayaquil realizas la mayor√≠a de tus actividades?', opt: ['Norte', 'Centro', 'Sur', 'Samborond√≥n / V√≠a a la Costa', 'Dur√°n'], type: 'single' }
    ];

    let current = 0;
    let results = {};
    let selections = [];
    let clickCount = 0;

    function render() {
        if (current >= questions.length) return final();
        const item = questions[current];
        const ui = document.getElementById('survey-ui');
        const footer = document.getElementById('footer-ui');
        
        const perc = Math.round((current / questions.length) * 100);
        document.getElementById('prog-bar').style.width = perc + '%';
        
        const left = questions.length - current;
        document.getElementById('questions-left').innerText = left === 1 ? '√öltima pregunta' : `Faltan ${left} preguntas`;
        document.getElementById('section-name').innerText = item.s;

        selections = [];
        footer.classList.toggle('hidden', item.type === 'single');

        ui.innerHTML = `
            <div class="fade-in">
                <p class="text-[10px] font-bold text-gray-300 uppercase tracking-widest mb-2 italic">Pregunta ${current + 1}</p>
                <h2 class="text-2xl font-black text-gray-800 leading-tight mb-8">${item.q}</h2>
                <div class="space-y-3 pb-20">
                    ${item.opt.map(o => `
                        <button onclick="pick('${o.replace(/'/g, "\\'")}')" class="opt-btn w-full text-left p-5 border-2 border-gray-100 rounded-2xl font-bold text-gray-500 transition-all hover:bg-gray-50 active:scale-[0.98]">
                            <div class="flex justify-between items-center">
                                <span>${o}</span>
                                <div class="indicator w-2 h-2 rounded-full bg-gray-200"></div>
                            </div>
                        </button>
                    `).join('')}
                </div>
            </div>
        `;
    }

    window.pick = (val) => {
        const item = questions[current];
        const btns = document.querySelectorAll('.opt-btn');

        if (item.type === 'single') {
            if (item.exit && val === item.exit) return finishExit();
            results[item.id] = val;
            event.currentTarget.classList.add('option-selected');
            setTimeout(() => { current++; render(); }, 300);
        } else {
            if (selections.includes(val)) selections = selections.filter(s => s !== val);
            else if (selections.length < item.max) selections.push(val);
            
            btns.forEach(b => {
                const bText = b.querySelector('span').innerText.trim();
                const indicator = b.querySelector('.indicator');
                if (selections.includes(bText)) {
                    b.classList.add('option-selected');
                    indicator.classList.replace('bg-gray-200', 'bg-xigo');
                } else {
                    b.classList.remove('option-selected');
                    indicator.classList.replace('bg-xigo', 'bg-gray-200');
                }
            });
            results[item.id] = selections;
        }
    };

    window.next = () => {
        if (selections.length === 0) return;
        current++;
        render();
    };

    function final() {
        document.getElementById('footer-ui').classList.add('hidden');
        document.getElementById('prog-bar').style.width = '100%';
        document.getElementById('questions-left').innerText = 'Completado';
        
        document.getElementById('survey-ui').innerHTML = `
            <div class="text-center py-4 fade-in">
                <div class="text-6xl mb-6">üéÅ</div>
                <h2 class="text-3xl font-black text-gray-800 mb-4 uppercase italic tracking-tighter">¬°EXCELENTE!</h2>
                <p class="text-gray-400 font-medium mb-8">Ingresa tu correo para recibir tu cup√≥n del 15% de descuento en <b>Vina Mar√≠a</b>.</p>
                <input type="email" id="email" placeholder="tu@email.com" class="w-full p-5 bg-gray-50 rounded-2xl border-2 border-transparent focus:border-xigo outline-none text-center font-bold text-lg mb-4">
                <button onclick="save()" id="save-btn" class="w-full bg-xigo text-white py-5 rounded-2xl font-black uppercase tracking-widest shadow-xl active:scale-95 transition-all">Obtener Cup√≥n</button>
            </div>
        `;
    }

    async function save() {
        const email = document.getElementById('email').value;
        if (!email.includes('@')) return;
        const btn = document.getElementById('save-btn');
        btn.disabled = true;
        btn.innerText = "GUARDANDO...";
        
        const data = { 
            email, 
            results, 
            ts: new Date().toISOString(),
            userAgent: navigator.userAgent
        };

        if (db) {
            try { 
                // Ruta estricta de Firestore para persistencia seg√∫n requerimientos
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('responses').add(data); 
                showSuccess();
            } catch (e) { 
                console.error(e);
                btn.disabled = false;
                btn.innerText = "Error al guardar. Reintentar";
            }
        } else {
            // Backup local si falla internet moment√°neamente
            localStorage.setItem('xigo_backup_' + Date.now(), JSON.stringify(data));
            showSuccess();
        }
    }

    function showSuccess() {
        document.getElementById('survey-ui').innerHTML = `
            <div class="text-center py-10 fade-in">
                <div class="w-16 h-16 bg-green-100 text-xigo rounded-full flex items-center justify-center mx-auto mb-6 text-2xl">‚úì</div>
                <h2 class="text-xigo text-4xl font-black italic mb-2">XIGO15</h2>
                <p class="font-bold text-gray-800 mb-6 uppercase tracking-widest text-[10px]">Tu c√≥digo de descuento</p>
                <div class="p-6 bg-gray-50 rounded-3xl border-2 border-dashed border-gray-200 text-sm text-gray-400 font-medium leading-relaxed">
                    Muestra este c√≥digo o una captura de pantalla en <b>@vinamariaec</b> para validar tu beneficio.
                </div>
                <button onclick="location.reload()" class="mt-12 text-gray-300 font-bold uppercase text-[9px] tracking-[0.4em] hover:text-xigo transition-colors">Finalizar encuesta</button>
            </div>
        `;
    }

    function finishExit() {
        document.getElementById('survey-ui').innerHTML = `
            <div class="text-center py-20 px-10 fade-in">
                <p class="text-gray-300 font-bold uppercase tracking-widest leading-relaxed text-sm">Gracias por tu honestidad. Esta encuesta est√° dirigida a compradores frecuentes de comida preparada.</p>
                <button onclick="location.reload()" class="mt-8 text-xigo font-black uppercase text-[10px] tracking-widest">Volver al inicio</button>
            </div>
        `;
    }

    // ACCESO ADMIN (5 clics en el logo)
    document.getElementById('admin-trigger').onclick = () => {
        clickCount++;
        if (clickCount >= 5) {
            const p = prompt("Password Admin:");
            if (p === ADMIN_PASS) showAdmin();
            clickCount = 0;
        }
    };

    async function showAdmin() {
        if (!db) return alert("No hay conexi√≥n a la base de datos");
        const ui = document.getElementById('survey-ui');
        ui.innerHTML = `<p class="text-center p-10 font-bold text-gray-400">Consultando base de datos en tiempo real...</p>`;
        
        try {
            const snap = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('responses').get();
            ui.innerHTML = `
                <div class="space-y-4 fade-in">
                    <div class="p-8 bg-xigo text-white rounded-3xl shadow-xl">
                        <p class="text-[10px] uppercase font-bold opacity-60 tracking-widest mb-1">Base de Datos XIGO</p>
                        <p class="text-6xl font-black italic tracking-tighter">${snap.size}</p>
                        <p class="text-xs mt-2 font-bold opacity-80 uppercase tracking-widest">Respuestas Guardadas</p>
                    </div>
                    <div class="p-6 border-2 border-gray-50 rounded-3xl">
                        <p class="text-[10px] font-black text-gray-300 uppercase mb-4 tracking-widest">√öltimos correos:</p>
                        <div class="space-y-2 max-h-40 overflow-y-auto">
                            ${snap.docs.reverse().slice(0, 10).map(doc => `
                                <div class="text-xs font-bold text-gray-500 border-b border-gray-50 pb-1 flex justify-between">
                                    <span>${doc.data().email}</span>
                                    <span class="text-[8px] opacity-40">${new Date(doc.data().ts).toLocaleDateString()}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <button onclick="location.reload()" class="w-full py-4 rounded-2xl font-bold uppercase text-[10px] text-gray-400 tracking-widest">Cerrar Sesi√≥n Admin</button>
                </div>
            `;
        } catch (e) {
            ui.innerHTML = `<p class="text-center text-red-500 p-10">Error de conexi√≥n: ${e.message}</p>`;
        }
    }

    render();
</script>

<style>
    .fade-in { animation: fadeIn 0.5s ease-out forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>

</body>
</html>
