<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>XIGO - Encuesta Oficial</title>
    <!-- Estilos Premium -->
    <style>
        :root { --primary: #2D5A27; --bg: #ffffff; --text: #1e293b; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        body { margin: 0; padding: 0; background: #f1f5f9; display: flex; justify-content: center; min-height: 100vh; }
        #app { background: white; width: 100%; max-width: 500px; min-height: 100vh; display: flex; flex-direction: column; position: relative; }
        
        .header { background: #000; height: 160px; display: flex; align-items: center; justify-content: center; border-bottom: 4px solid var(--primary); overflow: hidden; }
        .header img { width: 100%; height: 100%; object-fit: cover; }

        .progress-container { padding: 15px 25px 0; }
        .progress-bar { background: #f1f5f9; height: 6px; border-radius: 10px; overflow: hidden; }
        .progress-fill { background: var(--primary); height: 100%; width: 0%; transition: width 0.4s ease; }
        
        .content { flex: 1; padding: 25px; display: flex; flex-direction: column; }
        .section-tag { font-size: 10px; font-weight: 800; color: var(--primary); text-transform: uppercase; letter-spacing: 1.2px; margin-bottom: 5px; }
        .question-title { font-size: 1.1rem; font-weight: 700; color: var(--text); line-height: 1.3; margin-bottom: 20px; }
        
        .option-btn { 
            width: 100%; padding: 14px 18px; margin-bottom: 10px; border: 2px solid #f1f5f9;
            border-radius: 12px; text-align: left; font-weight: 600; color: #475569;
            background: white; cursor: pointer; transition: all 0.2s; font-size: 14px;
        }
        .option-btn.selected { border-color: var(--primary); background: #f0fdf4; color: var(--primary); }
        
        .footer { padding: 15px 25px 30px; border-top: 1px solid #f1f5f9; }
        .next-btn { 
            width: 100%; background: var(--primary); color: white; border: none;
            padding: 18px; border-radius: 12px; font-weight: 800; font-size: 14px;
            text-transform: uppercase; cursor: pointer; display: none;
        }
        
        .admin-card { background: #f8fafc; padding: 10px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid var(--primary); font-size: 12px; }
        .hidden { display: none !important; }
        
        /* Pantalla de carga */
        #loader { position: absolute; inset: 0; background: white; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    <!-- Firebase SDKs (Compat mode para mayor estabilidad) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
</head>
<body>
    <div id="app">
        <div id="loader">
            <div class="spinner"></div>
            <p style="margin-top: 15px; font-weight: 600; color: #64748b;">Iniciando encuesta...</p>
        </div>

        <div class="header" id="header-admin-trigger">
             <img src="https://lh3.googleusercontent.com/u/0/d/1WmKpnJPnBgB3OyYqe-a-OgRODLuuPjTq=w1600-h1600-iv1" alt="XIGO">
        </div>

        <div class="progress-container" id="prog-ui">
            <div class="progress-bar"><div id="progress-fill" class="progress-fill"></div></div>
            <p id="step-counter" style="font-size: 10px; color: #94a3b8; margin-top: 5px; text-align: right;"></p>
        </div>

        <div class="content" id="main-content"></div>

        <div class="footer" id="footer-ui">
            <button id="next-btn" class="next-btn" onclick="nextStep()">Continuar</button>
        </div>
    </div>

    <script>
        // --- CONFIGURACI√ìN FIREBASE ---
        let db = null;
        let auth = null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'xigo-encuesta-guayaquil';

        try {
            const firebaseConfig = JSON.parse(__firebase_config);
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
        } catch (e) { console.error("Firebase no configurado o fall√≥."); }

        // --- DATOS DE LA ENCUESTA (BASADO EN TU PDF) ---
        const surveySteps = [
            { id: 'F1', section: 'FILTRO', type: 'single', q: '¬øEn los √∫ltimos 30 d√≠as, has comprado comida preparada o empacada para consumir fuera de casa?', options: ['S√≠, lo he comprado', 'No, pero lo considerar√≠a', 'No, no me interesa'], terminate: 'No, no me interesa' },
            { id: 'F2', section: 'FILTRO', type: 'single', q: '¬øCu√°l describe mejor tu situaci√≥n actual?', options: ['Trabajo fuera de casa', 'Trabajo desde casa/online', 'Trabajo mixto', 'Estudiante / No trabajo'] },
            { id: 'F3', section: 'FILTRO', type: 'single', q: '¬øCon qu√© frecuencia almuerzas fuera de casa en una semana?', options: ['0 veces', '1-2 veces', '3-4 veces', '5+ veces'] },
            { id: 'C3', section: 'COMIDA', type: 'multi', q: '¬øQu√© tipo de comida te genera m√°s confianza si viene lista y empacada? (Elige hasta 3)', options: ['Comida tradicional ecuatoriana', 'Comida casera ligera', 'Bowls balanceados', 'Ensaladas completas', 'Sopas / Cremas', 'Snacks salados'], max: 3 },
            { id: 'P2', section: 'PRECIOS', type: 'single', q: '¬øQu√© precio te parece razonable por un almuerzo listo y fresco?', options: ['Menos de $4.99', '$5.99 - $7.99', '$7.99 - $9.99', '$9.99 - $11.99', 'M√°s de $11.99'] },
            { id: 'R2', section: 'BEBIDAS', type: 'multi', q: '¬øQu√© bebida RTD (lista para tomar) te resulta m√°s atractiva?', options: ['Agua saborizada', 'Jugo natural fresco', 'T√© fr√≠o / Infusi√≥n', 'Caf√© Latte / Matcha', 'Bebida funcional', 'Bebida refrescante'], max: 2 },
            { id: 'D2', section: 'PERFIL', type: 'single', q: '¬øEn qu√© zona de Guayaquil realizas tus actividades?', options: ['Norte', 'Centro', 'Sur', 'Samborond√≥n / V√≠a a la Costa', 'Dur√°n'] }
        ];

        let currentIdx = 0;
        let responses = {};
        let tempMulti = [];
        let adminClickCount = 0;

        // --- L√ìGICA DE INICIO ---
        async function startApp() {
            if (auth) {
                try { await auth.signInAnonymously(); } catch(e) {}
            }
            document.getElementById('loader').classList.add('hidden');
            renderStep();
        }

        function renderStep() {
            const step = surveySteps[currentIdx];
            const main = document.getElementById('main-content');
            const nextBtn = document.getElementById('next-btn');
            
            // Actualizar Progreso
            document.getElementById('progress-fill').style.width = `${(currentIdx / surveySteps.length) * 100}%`;
            document.getElementById('step-counter').innerText = `Pregunta ${currentIdx + 1} de ${surveySteps.length}`;
            
            tempMulti = [];
            nextBtn.style.display = 'none';

            main.innerHTML = `
                <div class="section-tag">${step.section}</div>
                <h2 class="question-title">${step.q}</h2>
                <div id="options-container">
                    ${step.options.map(opt => `
                        <button class="option-btn" onclick="selectOption('${opt.replace(/'/g, "\\'")}')">${opt}</button>
                    `).join('')}
                </div>
            `;
        }

        window.selectOption = (val) => {
            const step = surveySteps[currentIdx];
            const btns = document.querySelectorAll('.option-btn');

            if (step.type === 'single') {
                if (step.terminate && val === step.terminate) { finishPremature(); return; }
                responses[step.id] = val;
                btns.forEach(b => b.classList.toggle('selected', b.innerText === val));
                setTimeout(() => { currentIdx++; if(currentIdx < surveySteps.length) renderStep(); else renderFinal(); }, 300);
            } else {
                if (tempMulti.includes(val)) {
                    tempMulti = tempMulti.filter(v => v !== val);
                } else if (tempMulti.length < (step.max || 10)) {
                    tempMulti.push(val);
                }
                responses[step.id] = tempMulti;
                btns.forEach(b => b.classList.toggle('selected', tempMulti.includes(b.innerText)));
                document.getElementById('next-btn').style.display = tempMulti.length > 0 ? 'block' : 'none';
            }
        };

        window.nextStep = () => {
            currentIdx++;
            if (currentIdx < surveySteps.length) renderStep();
            else renderFinal();
        };

        function renderFinal() {
            document.getElementById('prog-ui').classList.add('hidden');
            document.getElementById('footer-ui').classList.add('hidden');
            document.getElementById('main-content').innerHTML = `
                <div style="text-align: center; padding-top: 20px;">
                    <h2 class="question-title">¬°Gracias por participar!</h2>
                    <p style="color: #64748b; font-size: 14px; margin-bottom: 25px;">D√©janos tu correo para enviarte tu cup√≥n del 15% en Vina Mar√≠a.</p>
                    <input type="email" id="email-final" placeholder="email@ejemplo.com" 
                        style="width: 100%; padding: 16px; border: 2px solid #e2e8f0; border-radius: 12px; margin-bottom: 20px; text-align: center; font-size: 16px;">
                    <button id="save-btn" onclick="saveData()" class="next-btn" style="display:block">RECIBIR CUP√ìN</button>
                </div>
            `;
        }

        async function saveData() {
            const email = document.getElementById('email-final').value;
            if (!email.includes('@')) { alert("Por favor ingresa un correo v√°lido"); return; }
            
            const btn = document.getElementById('save-btn');
            btn.innerText = "GUARDANDO...";
            btn.disabled = true;

            const finalPayload = {
                email,
                responses,
                date: new Date().toISOString(),
                userAgent: navigator.userAgent
            };

            // Guardar en Firestore si est√° disponible
            if (db) {
                try {
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('responses').add(finalPayload);
                } catch (e) { console.error("Error guardando en nube:", e); }
            }

            // Mostrar cup√≥n
            document.getElementById('main-content').innerHTML = `
                <div style="text-align: center; padding-top: 30px;">
                    <div style="font-size: 50px;">üç∑</div>
                    <h2 class="question-title" style="color: var(--primary); margin-top:10px;">C√ìDIGO: XIGO15</h2>
                    <p style="font-size: 14px; color: #64748b;">Presenta este c√≥digo en <b>@vinamariaec</b> para canjear tu 15% de descuento.</p>
                    <button onclick="location.reload()" style="margin-top:30px; background:none; border:none; color:var(--primary); font-weight:700; cursor:pointer;">Cerrar</button>
                </div>
            `;
        }

        function finishPremature() {
            document.getElementById('prog-ui').classList.add('hidden');
            document.getElementById('footer-ui').classList.add('hidden');
            document.getElementById('main-content').innerHTML = `<div style="text-align:center; padding-top:100px; color:#94a3b8;"><p>Gracias por tu inter√©s. Buscamos un perfil espec√≠fico por ahora.</p><button onclick="location.reload()">Regresar</button></div>`;
        }

        // --- SISTEMA ADMIN (5 clicks en el logo) ---
        document.getElementById('header-admin-trigger').onclick = () => {
            adminClickCount++;
            if (adminClickCount >= 5) {
                const pass = prompt("Contrase√±a Admin:");
                if (pass === "XIGO2026") showAdmin();
                adminClickCount = 0;
            }
        };

        async function showAdmin() {
            const main = document.getElementById('main-content');
            document.getElementById('prog-ui').classList.add('hidden');
            main.innerHTML = "<h4>Cargando base de datos...</h4>";
            
            if (!db) { main.innerHTML = "Error: Base de datos no conectada."; return; }

            try {
                const snap = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('responses').get();
                let html = `<h4>Respuestas (${snap.size})</h4>`;
                snap.forEach(doc => {
                    const d = doc.data();
                    html += `<div class="admin-card"><b>${d.email}</b><br><small>${new Date(d.date).toLocaleString()}</small></div>`;
                });
                html += `<button onclick="location.reload()" class="next-btn" style="display:block">Cerrar</button>`;
                main.innerHTML = html;
            } catch (e) { main.innerHTML = "Error al leer datos."; }
        }

        window.onload = startApp;
    </script>
</body>
</html>
