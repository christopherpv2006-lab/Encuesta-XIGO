<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>XIGO - Encuesta de Mercado</title>
    
    <style>
        :root { --primary: #2D5A27; --bg: #f8fafc; --text: #1e293b; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            margin: 0; padding: 0; background: var(--bg); 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            display: flex; justify-content: center; align-items: center; min-height: 100vh;
        }
        #app { 
            background: white; width: 100%; max-width: 500px; height: 100vh; 
            display: flex; flex-direction: column; overflow: hidden; position: relative;
        }
        @media (min-height: 600px) and (min-width: 500px) {
            #app { height: 850px; border-radius: 24px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.15); }
        }
        .header { background: var(--primary); height: 120px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .header img { height: 60px; filter: brightness(0) invert(1); }
        .progress-container { padding: 15px 25px 5px; background: white; }
        .progress-bar { background: #f1f5f9; height: 6px; border-radius: 10px; overflow: hidden; }
        .progress-fill { background: var(--primary); height: 100%; width: 0%; transition: width 0.4s ease; }
        .content { flex: 1; padding: 25px; overflow-y: auto; display: flex; flex-direction: column; }
        .section-tag { font-size: 11px; font-weight: 800; color: var(--primary); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 8px; }
        .question-title { font-size: 1.2rem; font-weight: 800; color: var(--text); line-height: 1.3; margin-bottom: 20px; }
        .option-btn { 
            width: 100%; padding: 14px 18px; margin-bottom: 10px; border: 2px solid #f1f5f9;
            border-radius: 14px; text-align: left; font-weight: 600; color: #64748b;
            background: white; cursor: pointer; transition: all 0.2s; font-size: 14px;
        }
        .option-btn:active { transform: scale(0.98); }
        .option-btn.selected { border-color: var(--primary); background: #f0fdf4; color: var(--primary); }
        .footer { padding: 15px 25px 30px; background: white; border-top: 1px solid #f1f5f9; }
        .next-btn { 
            width: 100%; background: var(--primary); color: white; border: none;
            padding: 18px; border-radius: 14px; font-weight: 800; font-size: 15px;
            text-transform: uppercase; cursor: pointer; transition: opacity 0.3s;
        }
        .next-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .loading-screen { 
            position: absolute; inset: 0; background: white; z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .spinner { width: 35px; height: 35px; border: 4px solid #f1f5f9; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none !important; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
</head>
<body>

    <div id="app">
        <div id="loader" class="loading-screen">
            <div class="spinner"></div>
            <p style="margin-top: 15px; color: #64748b; font-size: 13px;">Cargando encuesta XIGO...</p>
        </div>

        <div class="header">
             <img src="https://i.ibb.co/SD87TqHW/Black-Modern-Minimalist-Letter-A-Logo-1-1.png" alt="Logo XIGO">
        </div>

        <div class="progress-container" id="prog-wrapper">
            <div class="progress-bar">
                <div id="progress-fill" class="progress-fill"></div>
            </div>
            <p id="step-counter" style="font-size: 10px; color: #94a3b8; margin-top: 5px; text-align: right; font-weight: bold;"></p>
        </div>

        <div class="content" id="main-content"></div>

        <div class="footer" id="footer-actions">
            <button id="next-btn" class="next-btn" style="display: none;">Continuar</button>
        </div>
    </div>

    <script>
        const surveyData = [
            // BLOQUE 0
            { id: 'F1', section: 'FILTRO', type: 'single', q: '¬øEn los √∫ltimos 30 d√≠as, has comprado comida preparada o empacada para consumir fuera de casa o en tu trabajo/universidad?', options: ['S√≠, lo he comprado', 'No, pero lo considerar√≠a si fuera conveniente', 'No, no me interesa'], terminate: 'No, no me interesa' },
            { id: 'F2', section: 'FILTRO', type: 'single', q: '¬øCu√°l describe mejor tu situaci√≥n actual?', options: ['Trabajo fuera de casa', 'Trabajo desde casa/online', 'Trabajo mixto [Oficina + casa]', 'Estudiante/ No trabajo'] },
            { id: 'F3', section: 'FILTRO', type: 'single', q: '¬øCon qu√© frecuencia almuerzas fuera de casa en una semana?', options: ['0 veces', '1-2 veces', '3-4 veces', '5+ veces'] },
            // BLOQUE 1
            { id: 'C1', section: 'COMIDA', type: 'single', q: '¬øHas comprado alguna vez comida preparada para consumir despu√©s (Refrigerada o en tarrinas empacadas)?', options: ['S√≠, regularmente', 'S√≠, algunas veces', 'No, pero me llama la atenci√≥n', 'No, no me interesa'] },
            { id: 'C2', section: 'COMIDA', type: 'multi', q: '¬øEn qu√© situaciones considerar√≠as consumir comida lista durante un d√≠a laboral?', options: ['Con poco tiempo para salir almorzar', 'Reuniones o trabajo continuo', 'No alcanc√© a cocinarme', 'Para comer en la oficina', 'Entre reuniones o traslados', 'Para llevar a casa', 'No lo considero'], max: 7 },
            { id: 'C3', section: 'COMIDA', type: 'multi', q: '¬øQu√© tipo de comida te genera m√°s apetito y confianza si viene lista y empacada?', options: ['Comida tradicional ecuatoriana', 'Comida casera ligera (arroz, carne, pollo)', 'Bowls balanceados (sushi, prote√≠na, pasta)', 'Ensaladas completas', 'Sopas / Cremas', 'Snacks salados', 'No confiar√≠a en comida empacada'], max: 3 },
            { id: 'C4', section: 'COMIDA', type: 'single', q: 'Para tu almuerzo/cena, ¬øqu√© tama√±o de porci√≥n prefieres normalmente?', options: ['Ligero (para no sentirse pesado)', 'Normal (me deja satisfecho)', 'Grande (me gusta quedar lleno)', 'Depende del d√≠a'] },
            { id: 'C5', section: 'COMIDA', type: 'multi', q: '¬øQu√© esperas de un almuerzo para sentir que "vali√≥ la pena"?', options: ['Que me llene (porci√≥n)', 'Que sea saludable', 'Buena cantidad de prote√≠na', 'Que sea r√°pido y pr√°ctico', 'Que tenga muy buen sabor'], max: 3 },
            { id: 'C6', section: 'COMIDA', type: 'multi', q: '¬øQu√© factor te har√≠a dudar?', options: ['Frescura', 'Higiene', 'Sabor', 'Precio', 'Tama√±o de porci√≥n', 'Conservantes', 'Fecha de caducidad', 'Empaque sostenible'], max: 3 },
            { id: 'C7', section: 'COMIDA', type: 'single', q: 'Si tuvieras acceso a comida lista, fresca y de calidad cerca de tu rutina, ¬øcon qu√© frecuencia la consumir√≠as?', options: ['Nunca', '1 vez por semana', '2-3 veces por semana', 'Casi todos los d√≠as'] },
            // BLOQUE 2
            { id: 'DLY1', section: 'DELIVERY', type: 'single', q: '¬øConsiderar√≠as pedir comida lista por delivery si fuera confiable, fresca y de calidad?', options: ['S√≠, con frecuencia', 'S√≠, ocasionalmente', 'Tal vez', 'No'] },
            { id: 'DLY2', section: 'DELIVERY', type: 'single', q: '¬øQu√© formato de pedido por delivery te resulta m√°s atractivo?', options: ['Pedir comida puntual cuando la necesito', 'Pedir comida para 2-3 d√≠as', 'Pedir comida para toda la semana laboral', 'Depende del momento', 'No pedir√≠a por delivery'] },
            { id: 'DLY3', section: 'DELIVERY', type: 'single', q: 'Si este tipo de comida estuviera disponible por delivery, ¬øcon qu√© frecuencia la pedir√≠as?', options: ['Nunca', '1 vez por semana', '2-3 veces por semana', 'M√°s de 3 veces por semana'] },
            // BLOQUE 3
            { id: 'P1', section: 'PRECIOS', type: 'single', q: '¬øEn promedio, cu√°nto sueles pagar hoy por tu almuerzo entre semana?', options: ['Menos de $4.99', '$5.99 - $7.99', '$7.99 - $9.99', '$9.99 - $11.99', '$11.99 o m√°s', 'No pago almuerzo'] },
            { id: 'P2', section: 'PRECIOS', type: 'single', q: '¬øQu√© precio te parece razonable para un almuerzo listo, fresco y de excelente calidad?', options: ['Menos de $4.99', '$5.99 - $7.99', '$7.99 - $9.99', '$9.99 - $11.99', '$11.99 o m√°s'] },
            { id: 'P3', section: 'PRECIOS', type: 'single', q: '¬øA partir de qu√© precio considerar√≠as que este almuerzo ya es CARO?', options: ['Menos de $4.99', '$5.99 - $7.99', '$7.99 - $9.99', '$9.99 - $11.99', '$11.99 o m√°s'] },
            { id: 'P4', section: 'PRECIOS', type: 'single', q: 'Si un almuerzo que hoy compras a $5.99 pasara a costar $7.99. ¬øQu√© har√≠as?', options: ['Lo seguir√≠a comprando igual', 'Lo comprar√≠a con menos frecuencia', 'Buscar√≠a otra opci√≥n', 'Dejar√≠a de comprarlo'] },
            // BLOQUE 4
            { id: 'R1', section: 'RTD', type: 'single', q: 'Durante tu jornada laboral, ¬øcompras bebidas listas para tomar?', options: ['S√≠, casi todos los d√≠as', 'Varias veces por semana', 'Ocasionalmente', 'Rara vez', 'Nunca'] },
            { id: 'R2', section: 'RTD', type: 'multi', q: '¬øCu√°l de estas bebidas listas para llevar te resultar√≠a m√°s atractiva?', options: ['Agua natural/saborizada (baja az√∫car)', 'Jugo natural prensado / fresco', 'T√© fr√≠o o infusi√≥n natural', 'Caf√© latte y Matcha', 'Bebida funcional (energ√≠a, prote√≠na)', 'Bebida refrescante', 'No suelo comprar bebidas'], max: 2 },
            { id: 'R3', section: 'RTD', type: 'multi', q: 'Cuando compras bebidas con leche, ¬øcu√°l prefieres normalmente?', options: ['Leche regular (entera)', 'Leche deslactosada', 'Leche de almendra', 'Leche de avena', 'Leche de soya', 'No consumo bebidas con leche'], max: 2 },
            { id: 'R4', section: 'RTD', type: 'single', q: '¬øQu√© precio te parece razonable para una bebida lista (RTD) de buena calidad?', options: ['Hasta $1.99', '$2.49 - $2.99', '$3.49 - $3.99', '$4.49 - $4.99', 'M√°s de $5.00'] },
            // BLOQUE FINAL
            { id: 'D1', section: 'PERFIL', type: 'single', q: '¬øCu√°l es tu rango de edad?', options: ['18-24', '25-34', '35-44', '45-54', '55+'] },
            { id: 'D2', section: 'PERFIL', type: 'single', q: '¬øEn qu√© zona realizas la mayor√≠a de tus actividades?', options: ['Norte', 'Centro', 'Sur', 'Samborond√≥n / V√≠a a la Costa', 'Dur√°n'] }
        ];

        let currentStep = 0;
        let answers = {};
        let selectedInStep = [];
        let db, appId;

        window.onload = async () => {
            const loader = document.getElementById('loader');
            try {
                if (typeof firebase !== 'undefined' && typeof __firebase_config !== 'undefined') {
                    const config = JSON.parse(__firebase_config);
                    firebase.initializeApp(config);
                    db = firebase.firestore();
                    appId = typeof __app_id !== 'undefined' ? __app_id : 'xigo-encuesta-final';
                    await firebase.auth().signInAnonymously();
                }
            } catch (e) { console.warn("Modo offline activado"); }
            loader.classList.add('hidden');
            render();
        };

        function render() {
            const main = document.getElementById('main-content');
            const nextBtn = document.getElementById('next-btn');
            const fill = document.getElementById('progress-fill');
            const counter = document.getElementById('step-counter');
            
            if (currentStep >= surveyData.length) {
                renderFinal();
                return;
            }

            const step = surveyData[currentStep];
            selectedInStep = [];
            nextBtn.style.display = 'none';
            fill.style.width = `${(currentStep / surveyData.length) * 100}%`;
            counter.innerText = `Pregunta ${currentStep + 1} de ${surveyData.length}`;

            let html = `
                <div style="animation: fadeIn 0.5s ease">
                    <div class="section-tag">${step.section}</div>
                    <h2 class="question-title">${step.q}</h2>
                    <div id="options-grid">
                        ${step.options.map(opt => `
                            <button class="option-btn" onclick="handleSelect('${opt.replace(/'/g, "\\'")}')">${opt}</button>
                        `).join('')}
                    </div>
                    ${step.type === 'multi' ? `<p style="font-size:11px; color:#94a3b8; margin-top:10px;">* Puedes elegir hasta ${step.max} opciones</p>` : ''}
                </div>
            `;
            main.innerHTML = html;
            main.scrollTop = 0;
        }

        window.handleSelect = (val) => {
            const step = surveyData[currentStep];
            const btns = document.querySelectorAll('.option-btn');
            
            if (step.type === 'single') {
                if (step.terminate && val === step.terminate) {
                    renderTermination(); return;
                }
                answers[step.id] = val;
                btns.forEach(b => b.classList.toggle('selected', b.innerText === val));
                setTimeout(() => { currentStep++; render(); }, 350);
            } else {
                if (selectedInStep.includes(val)) {
                    selectedInStep = selectedInStep.filter(v => v !== val);
                } else {
                    if (selectedInStep.length >= step.max) return;
                    selectedInStep.push(val);
                }
                answers[step.id] = selectedInStep;
                btns.forEach(b => b.classList.toggle('selected', selectedInStep.includes(b.innerText)));
                document.getElementById('next-btn').style.display = selectedInStep.length > 0 ? 'block' : 'none';
            }
        };

        document.getElementById('next-btn').onclick = () => {
            currentStep++;
            render();
        };

        function renderFinal() {
            document.getElementById('prog-wrapper').classList.add('hidden');
            document.getElementById('footer-actions').classList.add('hidden');
            document.getElementById('main-content').innerHTML = `
                <div style="text-align: center; padding-top: 30px; animation: fadeIn 0.6s ease">
                    <img src="https://cdn-icons-png.flaticon.com/512/5690/5690130.png" width="80" style="margin-bottom: 20px;">
                    <h2 class="question-title">¬°ENCUESTA COMPLETADA!</h2>
                    <p style="color: #64748b; font-size: 14px; margin-bottom: 25px;">Por tu participaci√≥n, recibe un cup√≥n del 15% para Vina Mar√≠a.</p>
                    <input type="email" id="user-email" placeholder="Tu correo electr√≥nico" 
                        style="width: 100%; padding: 16px; border: 2px solid #e2e8f0; border-radius: 14px; margin-bottom: 20px; text-align: center; font-size: 16px;">
                    <button onclick="saveAndFinish()" id="save-btn" class="next-btn" style="display: block;">RECLAMAR MI CUP√ìN</button>
                </div>
            `;
        }

        async function saveAndFinish() {
            const email = document.getElementById('user-email').value;
            if (!email.includes('@')) { alert("Ingresa un correo v√°lido"); return; }
            
            const btn = document.getElementById('save-btn');
            btn.disabled = true;
            btn.innerText = "ENVIANDO...";

            try {
                if (db) {
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('responses').add({
                        email, answers, timestamp: new Date().toISOString()
                    });
                }
                document.getElementById('main-content').innerHTML = `
                    <div style="text-align: center; padding-top: 50px; animation: fadeIn 0.6s ease">
                        <h1 style="font-size: 50px;">üç∑</h1>
                        <h2 class="question-title" style="color: var(--primary)">¬°LISTO!</h2>
                        <p style="color: #1e293b; font-weight: 700; font-size: 18px;">C√ìDIGO: XIGO15</p>
                        <p style="color: #64748b; font-size: 14px; margin-top: 15px;">Hemos enviado una copia a <b>${email}</b>. √ösalo en @vinamariaec</p>
                    </div>
                `;
            } catch (e) {
                alert("Error de conexi√≥n. Int√©ntalo de nuevo.");
                btn.disabled = false;
                btn.innerText = "RECLAMAR MI CUP√ìN";
            }
        }

        function renderTermination() {
            document.getElementById('prog-wrapper').classList.add('hidden');
            document.getElementById('footer-actions').classList.add('hidden');
            document.getElementById('main-content').innerHTML = `
                <div style="text-align: center; padding-top: 80px; color: #94a3b8;">
                    <p>Gracias por tu inter√©s. Por ahora buscamos otros perfiles para este estudio.</p>
                </div>
            `;
        }
    </script>
</body>
</html>
